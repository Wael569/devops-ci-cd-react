pipeline {
    agent any

    environment {
        DOCKER_USER = 'wael75613' // DockerHub username
    }

    stages {

        // 1️⃣ Checkout Stage
        stage('Checkout') {
            steps {
                echo "Checking out source code..."
                checkout scm
            }
        }

        // 2️⃣ Setup Stage
        stage('Setup') {
            steps {
                echo "Installing npm dependencies..."
                bat 'npm install'
            }
        }

        // 3️⃣ Build Stage
        stage('Build') {
            steps {
                echo "Building React app..."
                bat 'npm run build'
            }
        }

        // 4️⃣ Run Docker Stage
        stage('Run Docker') {
            steps {
                script {
                    // Use Git tag as version or default to 'latest'
                    def VERSION = env.GIT_TAG_NAME ?: 'latest'
                    echo "Using Docker version: ${VERSION}"
                    env.VERSION = VERSION
                }

                echo "Removing existing container if exists..."
                bat 'docker rm -f react-app || echo "No container to remove"'

                echo "Building Docker image..."
                bat "docker build -t %DOCKER_USER%/react-app:${env.VERSION} ."

                echo "Running Docker container..."
                bat "docker run -d --name react-app -p 80:80 %DOCKER_USER%/react-app:${env.VERSION}"

                echo "Waiting for container to start..."
                sleep time: 10, unit: 'SECONDS'

                bat 'docker ps'
            }
        }

        // 5️⃣ Smoke Test Stage
        stage('Smoke Test') {
            steps {
                echo "Running smoke tests..."
                bat 'smoke_test.bat'
            }
        }

        // 6️⃣ Archive Stage
        stage('Archive') {
            steps {
                echo "Archiving build artifacts..."
                archiveArtifacts 'build/**'
            }
        }

        // 7️⃣ Push Docker Image (only for tags)
        stage('Push Docker Image') {
            when { expression { env.GIT_TAG_NAME != null } }
            steps {
                echo "Pushing Docker image for tag ${env.VERSION}..."
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    bat "docker login -u %USER% -p %PASS%"
                    bat "docker push %DOCKER_USER%/react-app:${env.VERSION}"
                    bat "docker logout"
                }
            }
        }
    }

    post {
        always {
            echo "Cleaning up Docker container..."
            bat 'docker rm -f react-app || echo "No container to remove"'
        }
    }
}
